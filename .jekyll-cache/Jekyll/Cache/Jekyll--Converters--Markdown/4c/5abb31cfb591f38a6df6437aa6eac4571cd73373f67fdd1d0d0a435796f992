I"sG<h1 id="getting-around-to-it">Getting around to it</h1>

<p>I pulled an old CPC 618 out of the loft recently, by recently I mean during lock down 1, over a year ago. So having had it sit on the shelf in my home-office for a year, I decided to start playing with it, after a re-cap and of course the inevitable disk drive belt replacement.</p>

<div class="dbImg zoom50 centeredImg" data-src="cpc/cpc-128-replacement-belt.png" alt="Picture of a replacement belt in a bag."></div>

<div class="dbCaption">
The replacement belt, source url in the photo.
</div>

<p>That year between pulling the CPC out of the attic and actually getting around to doing something about it, is a good example of why I called this blog “Over taken by events”. The fact that the last post on this site was a year ago also, is equally indicative!</p>

<p>When I first had a plugged in and working system, via a hodgepodge of adaptors, I inserted a disc, typed <code class="language-plaintext highlighter-rouge">cat</code>, got a directory listing then typed <code class="language-plaintext highlighter-rouge">run"custard</code> to start the game, I thought I’d bossed it, What a memory!</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/cpc-custard-pie-factory.png" alt="Picture of a replacement belt in a bag."></div>

<div class="dbCaption">
Ahh, my first (worst) CPC game published by Tynesoft.
</div>

<p>However I pretty quickly realized I couldn’t remember any of the other disc commands. This post is the culmination of my head scratching around this and, I hope, might save you time if you’re getting back into the CPC.</p>

<p>The CPC had two distinct ways of accessing a floppy disc, AMSDOS: which was the native CPC disc access method, used to run CPC programs; and CPM, used to run business apps and Zork. CPM is beyond the scope of this article but I will cover it in a later post.</p>

<h2 id="beginnings">Beginnings</h2>

<p>The Amstrad CPC 464, the original Amstrad Color Personal Computer didn’t come with floppy support at all, it had a built in cassette deck. To add support external floppies you plugged in and expansion card, the snappily named DDI-1. This contained a 765 disc drive controller and a ROM that extended Locomotive BASIC with AMSDOS.The CPC 664, 6128 and the 6128plus all had the AMSDOS ROM built into the mainboard.</p>

<p>The tape oriented nature of the original CPC means that AMSDOS has a number of commands that deal with backwards and forwards compatibility. You can, for example disable the disc system completely and revert to all I/O being performed to tape again. On later CPCs with built in disc drives, tape based games and apps became rarer and for me at least, these commands were less frequently used.</p>

<p>The commands that you use to access and control discs are a mixture of built in BASIC commands and external commands in the ROM. Internal basic commands e.g. <code class="language-plaintext highlighter-rouge">cat</code> are typed as is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat
</code></pre></div></div>

<p>External commands, e.g. <code class="language-plaintext highlighter-rouge">dir</code> are prefixed with a vertical bar:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>¦dir
</code></pre></div></div>

<p>Commands are not case sensitive. You can find the <code class="language-plaintext highlighter-rouge">¦</code> symbol by pressing shift on the ‘@’ key.</p>

<p>Some commands take one or more parameters, these are separate from one another by a comma, <em>but more importantly</em> and frustratingly also from the command (this looks strange to modern eyes)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>¦ERA,"Hello.bas"
¦REN,"hello2.bas","hello.bas"
</code></pre></div></div>

<p>You do get used to it.</p>

<h2 id="internal-commands">Internal commands</h2>

<p>These commands operate on either the disc or the cassette depending on the current mode (covered in the next section)</p>

<table>
  <thead>
    <tr>
      <th>command</th>
      <th>overview</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CAT</td>
      <td>Catalogue (list) the files on the current device</td>
    </tr>
    <tr>
      <td>LOAD</td>
      <td>Load a file into memory</td>
    </tr>
    <tr>
      <td>RUN</td>
      <td>Load a basic file and run it</td>
    </tr>
    <tr>
      <td>SAVE</td>
      <td>Save data to a file</td>
    </tr>
    <tr>
      <td>CHAIN</td>
      <td>Load a basic file into memory replacing any existing program</td>
    </tr>
    <tr>
      <td>CHAIN MERGE</td>
      <td>Load a basic file into memory merging it with any existing program</td>
    </tr>
    <tr>
      <td>OPENIN</td>
      <td>Opens a file for reading via stream #9</td>
    </tr>
    <tr>
      <td>OPENOUT</td>
      <td>Opens a file for writing via stream #9</td>
    </tr>
    <tr>
      <td>CLOSEIN</td>
      <td>Closes the current input stream</td>
    </tr>
    <tr>
      <td>CLOSEOUT</td>
      <td>Closes the current output stream</td>
    </tr>
  </tbody>
</table>

<p>This isn’t a locomotive BASIC post so I’ll skip the detail on most of these. The most commonly used command is <code class="language-plaintext highlighter-rouge">cat</code> which lists the files on the current device, <code class="language-plaintext highlighter-rouge">load</code> whick loads basic files and <code class="language-plaintext highlighter-rouge">run</code>, which executes basic programs.</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/custard-loading.png" alt="Screenshot of a file being loaded"></div>

<div class="dbCaption">
Listing and running a program from disc
</div>

<h2 id="external-commands">External commands</h2>

<p>AMSDOS contains the following following external commands</p>

<table>
  <thead>
    <tr>
      <th>command</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦A</code></td>
      <td>Select disc A as the current disc</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦B</code></td>
      <td>Select disc B as the current disc</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦CPM</code></td>
      <td>Clear all memory and boot CPM from disc A</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦DIR</code></td>
      <td>Show a listing of the current directory</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦DISC</code></td>
      <td>Swap to disc mode for both input and output</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦DISC.IN</code></td>
      <td>Swap to disc mode for input, leaving output as it was</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦DISC.OUT</code></td>
      <td>Swap to disc mode for output, leaving input as it was</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦DRIVE</code></td>
      <td>Swap drive</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦ERA</code></td>
      <td>Erase a file</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦REN</code></td>
      <td>Rename a file</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦TAPE</code></td>
      <td>Swap to tape mode for both input and output</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦TAPE.IN</code></td>
      <td>Swap to tape mode for input, leaving output as it was</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦TAPE.OUT</code></td>
      <td>Swap to tape mode for output, leaving input as it was</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">¦USER</code></td>
      <td>Set the current user</td>
    </tr>
  </tbody>
</table>

<h3 id="setting-the-disc-mode">Setting the disc mode</h3>

<p>The CPC uses chanel / stream #9 in BASIC to read and write files. On an AMSDOS enabled CPC this stream is routed to either disc or tape and can have a different route for both input and output.</p>

<p>The <code class="language-plaintext highlighter-rouge">¦DISC</code> command sets both the input and output media to disc. It is the equivalent of executing the two commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>¦DISC.IN 
¦DISC.OUT
</code></pre></div></div>

<p>which set the input and output media separately.</p>

<p>The <code class="language-plaintext highlighter-rouge">¦TAPE</code> command sets both the input and output media to tape. It is the equivalent of executing the two commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>¦TAPE.IN 
¦TAPE.OUT
</code></pre></div></div>

<p>As an example of the use of these commands we can copy a file from tape to disk as follows</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/disc-tap-mode.png" alt="Screen shot of file copying from tape to disc."></div>

<div class="dbCaption">
Copying from tape to disc with a typo!
</div>

<h3 id="working-with-drives-drives">Working with drives drives</h3>

<p>AMSDOS and the CPC support two drives <code class="language-plaintext highlighter-rouge">A</code> and <code class="language-plaintext highlighter-rouge">B</code>. Notionally the chipset that controls the floppy drives can handle up to four devices, but I have never seen a setup for more than a pair of drives that didn’t require a hardware mod.</p>

<p>To swap to the <code class="language-plaintext highlighter-rouge">B</code> drive we can use either of the following commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>¦B
¦DRIVE,"B"
</code></pre></div></div>

<p>To swap back to the <code class="language-plaintext highlighter-rouge">A</code> drive we can similarly use:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>¦A
¦DRIVE,"A"
</code></pre></div></div>

<p>trying to swap to a drive that is has no disk in it, leads to the message</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Drive B: disc missing

Retry, Ignore or Cancel
</code></pre></div></div>

<p>And as in most disc commands, Retry and Ignore are wholely useless and Cancel is the only one to choose.</p>

<h3 id="listing-files">Listing files</h3>

<p>To get a list of files on the disc we can use either the internal <code class="language-plaintext highlighter-rouge">cat</code> command or the external <code class="language-plaintext highlighter-rouge">¦DIR</code> command.</p>

<p><code class="language-plaintext highlighter-rouge">CAT</code> returns the list of files on the currently selected device in the order that it encounters them, <em>and</em> also shows the file size.</p>

<p><code class="language-plaintext highlighter-rouge">¦DIR</code> returns the list of files on the disc but in alphabetical order, however it does not report the size of files. <code class="language-plaintext highlighter-rouge">¦DIR</code> does however always show disc content even when BASIC is in tape mode and supports:</p>
<ul>
  <li>wildcards</li>
  <li>multi-users</li>
  <li>showing the content of a drive even if it isn’t the currently selected one</li>
</ul>

<p>Both commands display the free space on the disc in kilobytes</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/cat-vs-dir.png" alt="Screen shot of cat and dir commands."></div>

<div class="dbCaption">
cat vs dir.
</div>

<p>To use wildcards, <code class="language-plaintext highlighter-rouge">¦DIR</code> can  be invoked as follows:</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/dir-wildcards.png" alt="Screen shot of cat and dir commands."></div>

<div class="dbCaption">
|dir with wild cards.
</div>

<p>To view the content of a non-selected drive:</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/dir-b.png" alt="Screen shot of a directory for an alternative drive."></div>

<div class="dbCaption">
Listing of the contents of drive B when drive A is the current drive.
</div>

<h3 id="deleting-files">Deleting files</h3>

<p>The erase command <code class="language-plaintext highlighter-rouge">¦ERA</code> is used to delete files, presumably erase was chose as the keyword because <code class="language-plaintext highlighter-rouge">delete</code> is already present Locomotive BASIC.</p>

<p><code class="language-plaintext highlighter-rouge">¦ERA</code> like <code class="language-plaintext highlighter-rouge">¦DIR</code> can operate on multiple files via wildcards and delete files on alternative drives</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/era.png" alt="Screen shot of erasing files."></div>

<div class="dbCaption">
Erasing files on drive A while drive B is selected. Rad!
</div>

<h3 id="multi-user-access">Multi user access</h3>

<p>If you read through this post a thousand times one thing you won’t find is any commands to create or change directories, they don’t exist in AMSDOS.</p>

<p>If multiple people are using the same computer and disc, how do we segregate the files for different users? The answer to this is via the <code class="language-plaintext highlighter-rouge">¦USER</code> command. AMSDOS supports up to 16 users, identified by a number 0 to 15.</p>

<p>You may have noticed this when listing files, if you look at the preceding screenshots the  <code class="language-plaintext highlighter-rouge">¦DIR</code> command outputs and a header <code class="language-plaintext highlighter-rouge">Drive A: user 0</code>, showing that by default we operate as user 0 and see the files for that user.</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/user.png" alt="Snippet of the user line"></div>

<div class="dbCaption">
User 0 is the default user
</div>

<p>If we perform a directory listing on drive A as user 0, then swap to user 10 and do the same, then we will see no files. The disk free space is still that same of course as there is no magic disc space pixie.</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/user-10.png" alt="User 10 has no files"></div>

<p>we can create a file as user 10 and save it, the file will then show up when listing files as user 10, but not user 0.</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/user-10-new-file.png" alt="Snippet of the user line"></div>

<div class="dbCaption">
User 0 is the default user
</div>

<p>Finally when acting as user 10 you can view any other users content by prefixing a filename, or wild card with the desired user number and a colon.</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/user-10-see-user-0-file.png" alt="Cross user dir"></div>

<div class="dbCaption">
User 10 taking a sneak peek at user 0's files
</div>

<p>Similarly you can specify the specify the user number for run save and load commands too.</p>

<p>What can’t do however combine a drive letter and a user as far as I can tell. If you are user 10 on drive A, then you are user 10 on drive B. If you want to see user 0’s files on another drive, swap to it.</p>

<h3 id="renaming-files">Renaming files</h3>

<p>The rename command changes file names, it is also used to assign files to different users.</p>

<p>to rename a file use the <code class="language-plaintext highlighter-rouge">|ren</code> command and specify the new name, then the original name</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|REN,"NEWNAME.BAS","ORIGINAL.BAS"
</code></pre></div></div>

<p>which will result in the file having the new name.</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/rename.png" alt="Renaming a file"></div>

<p><code class="language-plaintext highlighter-rouge">|ERA</code> can also be used to move files between numbered users on the disc.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|REN,"0:NEWNAME.BAS","10:ORIGINAL.BAS"
</code></pre></div></div>

<p>Here the file <code class="language-plaintext highlighter-rouge">original.bas</code> owned by user <code class="language-plaintext highlighter-rouge">10</code>, is being renamed to <code class="language-plaintext highlighter-rouge">newname.bas</code> owned by user <code class="language-plaintext highlighter-rouge">0</code>. I am showing it this way to highlight the name can change as well as the user, in practice the name  stays the same.</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/rename-change-user.png" alt="moving a file between users"></div>

<h3 id="you-wont-believe-this-one-trick-they-didnt-want-you-to-know">You won’t believe this one trick they didn’t want you to know!</h3>

<p>Sorry couldn’t resist the title…</p>

<p>There is a ‘hidden’ feature of the AMSDOS/CPM filesystem that can be really useful to recover from a
mistakenly erased file.</p>

<p>Erasing a file does not actually delete it immediately but changes the assigned user 229 (hex <code class="language-plaintext highlighter-rouge">E5</code>)</p>

<table>
  <tbody>
    <tr>
      <td>poke &amp;a701,229:</td>
      <td>ren,”0:hello.bas”,”hello.bas”:poke &amp;a701,0:cat</td>
    </tr>
  </tbody>
</table>

<h3 id="a-word-on-filenames">A word on filenames</h3>

<h3 id="the-cpm-command">The CP/M command</h3>

<p>With a CP/M boot disc in drive A, running the <code class="language-plaintext highlighter-rouge">¦CPM</code> command clears memory and boots in to CP/M. The CPC-464 came with CP/M version 2.2, the CPC-6128 came with both version 2.2 and the newer CP/M Plus edition.</p>

<div class="dbImg zoom200 centeredImg" data-src="cpc/cpm-plus.png" alt="Screen shot CP/M plus."></div>

<div class="dbCaption">
CPC booted into CP/M plus
</div>

:ET